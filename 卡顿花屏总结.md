目标：2小时内 视频30秒转完，现状128秒 差距四倍
a、转码速度（分片）：
    1、flv、avi不支持分片，快速分析一遍协议头，建立时钟-偏移索引
    2、分片耗时偏差大，比如动态帧率、录制类静帧视频，建立视频特征、转码速度--转码速度的曲线，动态调整分片大小
b、ffmpeg优化
    1、协议avio优化（单帧调用avio_read 2到3次，修改avio_read逻辑保证每次读到一帧）
    2、音视频交织间隔过大，反复seek http range消耗巨大，双缓存通道（hls转mp4） 30-70%
    3、滤镜优化，执行顺序、AVFilter slice级别threading   80%
c、调度：优先级队列（业务优先、短视频优先）、线性扩缩容
2、ffmpeg问题：音画，花屏，duration不对，seek慢音视频交织间隔大 
3、源视频异常：视频损坏，时钟回滚，交错等

其他痛点：
音画，时钟回滚，交错，duration不对等


## 卡顿
慢网效应下，指定时间内下载的数据不足导致播放卡顿
#### CDN做法
1. 音频对码率影响不大，而且人对非连续声音非常敏感，保留音频流
2. 视频丢帧，胡乱丢帧会导致播放花屏，常见做法：
a. 整个gop的丢，主观体验会有卡顿跳帧，但避免了花屏
b. 丢掉每个gop尾部的帧，优化做法是重新插入sps和pps(在sps数据包中，里面包含有非常重要的帧率信息)，配合调整帧率，让每一帧的播放时间延长，主观体验和程序卡顿都有很好效果
```
1、终端告知CDN OC终端的接收能力，比如每秒只能接收18帧（实际流畅播放帧率为30fps）
2、CDN OC控制发送的数据，按照丢弃每GOP内后面40%的音视频帧来丢数据，这样用户(观众)的肉眼卡顿感不强
3、为了保证足够时长播放，CDN OC配合重新下发SPS信息，重新定制帧率，这样也将消除“网慢效应”造成的卡顿
(4、最终数据写进播放器时，最好将时间戳dts重新调整均匀，防止部分播放器比如flv.js因时间戳不连续播放卡顿)
```

## 花屏
1. 参考帧（I帧或P帧）丢失或者内容损坏（a.网络丢包; b.接收端或发送端的随机丢帧策略），后续帧的解码依赖丢失帧，导致花屏（I帧丢失更严重：绿屏、黑屏）
2. 解码器出错，比如不兼容、sps和pps信息错误、码流尺寸发生变化没有重置解码器
3. 播放器问题, 打开或重新连接没有从关键帧开始解码


## 音视频同步播放原理
音频帧和视频帧都有自己的pts（没有的情况下需要根据采样率进行计算），播放时按照pts进行同步，由于人对非连续声音非常敏感，所以普遍策略是以音频播放为主逻辑，通过调整视频帧播放进行同步：

1. 如果音频比视频快，加快视频帧播放，比如丢帧播放
2. 如果音频比视频慢，放慢视频帧播放，延长当前帧的显示时间

```
1. 无法察觉：音频和视频的时间戳差值在：-100ms ~ +25ms 之间
2. 能够察觉：音频滞后了 100ms 以上，或者超前了 25ms 以上
3. 无法接受：音频滞后了 185ms 以上，或者超前了 90ms 以上
```

## 转封装慢 | 播放拖动慢
1、一小时视频转封装转了七八个个小时
2、播放拖拽时缓冲半天
#### av交织数据间隔异常大，需要反复seek，尤其是http range方式巨慢无比
a、源视频下载本地
b、两个-i，一路只取音频、一路只取视频，代价两倍带宽
./ffmpeg_4_0 -v 128 -y -i http://9.86.182.85:80/file/210131146_582245.f9998.mp4  -i http://9.86.182.85:80/file/210131146_582245.f9998.mp4 -filter_complex "[0]scale=w=240:h=-1[scale_1_out]" -map [scale_1_out]:v? -map 1:a?  -pix_fmt yuv420p -vcodec libx264  -x264-params preset=ultrafast -acodec libfdk_aac -ab 48k  -ar 44100 -bsf:v h264_mp4toannexb -f mpegts -threads 6 210070440_502986829.ts 2>log1.txt

root@9.86.182.85#grep "Statistics" log1.txt |grep read
[AVIOContext @ 0x35c0540] Statistics: 948222080 bytes read, 0 seeks
[AVIOContext @ 0x35c56c0] Statistics: 948222080 bytes read, 0 seeks
#### av交织数据间隔异常大，拖拽seek慢 
转码过程中封装阶段，如果源视频是hls，有一定的概率转码出来的mp4 av交织间隔很大

怎么查看音视频间隔
